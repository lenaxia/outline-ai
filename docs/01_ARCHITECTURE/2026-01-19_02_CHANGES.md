# Key Changes to HLD - Command-Driven Filing with Interactive Guidance + Webhooks

## Summary
1. Changed from automatic polling of a "scratch pad" collection to user-initiated filing via `/ai-file [guidance]` command with interactive feedback loop
2. Added webhook-first architecture using Outline's `documents.update` events for real-time detection (confirmed via source code analysis)
3. Implemented idempotent design for `/summarize` and search terms using hidden HTML comment markers
4. Simplified Q&A system to use only `/ai` command (removed `?!?` marker)

## Major Changes

### 1. System Overview
- **Before**: "Auto-Filing: Automatically categorizes and files documents from a scratch pad"
- **After**: "Command-Driven Filing: On-demand document categorization and filing via `/ai-file` command"

### 2. Architecture
- **Removed**: Auto-Filing Loop from main service
- **Enhanced**: Command Processor is now the primary trigger for filing
- **Simplified**: No need for complex document state tracking

### 3. Configuration
- **Removed**:
  - `scratch_pad_collection_id` - no longer need a specific source collection
  - `document_wait_time` - no waiting period needed
- **Added**:
  - `command_poll_interval` - how often to check for commands
  - `excluded_collection_ids` - collections to exclude as filing destinations

### 4. Persistence Layer
- **Simplified**: Removed complex DocumentState tracking (first_seen_at, waiting periods)
- **Focus**: Only track Q&A state to prevent duplicate answers
- **Optional**: CommandLog for audit trail

### 5. Filing Flow
- **Before**: Poll → Wait Period → Auto-file
- **After**: User adds `/ai-file` → Detect → File immediately

### 6. Commands
- **New Primary Command**: `/ai-file` - triggers document filing
- **Detection**: Uses Outline's search API to efficiently find command markers
- **Polling**: Single unified command polling loop

## New Feature: Interactive Guidance System

### Optional User Guidance
- Users can provide hints: `/ai-file engineering focused` or `/ai-file customer-facing`
- AI considers guidance along with content analysis
- Improves accuracy for ambiguous documents

### Low Confidence Feedback Loop
- When AI confidence < threshold, system converts `/ai-file` → `?ai-file`
- Adds comment explaining uncertainty with alternatives
- User can update with better guidance and retry
- Example:
  ```
  Original: /ai-file
  After low confidence: ?ai-file
  Comment: "⚠️ Uncertain between Engineering or Product.
            Try: /ai-file engineering focus"
  User updates: /ai-file backend implementation
  Result: Successfully filed with guidance
  ```

### Dual Marker System
- `/ai-file [guidance]` - Active command (will be processed)
- `?ai-file [guidance]` - Uncertain marker (needs user input)
- When both exist, process `/ai-file` and remove both on success

## Webhook Architecture (New Discovery)

### Outline Webhook Support
- **Confirmed**: Outline provides `documents.update` events via webhooks
- **Source**: Analyzed Outline repository code (`shared/utils/EventHelper.ts`)
- **Events available**: `documents.update`, `documents.create`, `documents.publish`, etc.

### Implementation
- **Primary method**: Webhook receiver at `/webhooks` endpoint
- **Subscribe to**: `["documents.update", "documents.create"]`
- **Security**: SHA-256 HMAC signature validation via `Outline-Signature` header
- **Timeout**: Must respond HTTP 200 within 5 seconds
- **Fallback**: Optional polling mode for local development

### Benefits
- **Real-time**: < 1 second response when commands added
- **Efficient**: 99% reduction in API calls vs polling
- **Reliable**: Exponential backoff on failures, auto-disable after 25 failures
- **Cost-effective**: Only uses API when documents change

## Idempotent Command Design

### Problem Solved
Running `/summarize` or document filing multiple times previously could result in:
- Duplicate summaries stacking up
- Search terms appended repeatedly
- Messy, cluttered documents

### Solution: Hidden Marker Pattern
Uses HTML comment markers invisible in rendered markdown:

```markdown
<!-- AI-SUMMARY-START -->
> **Summary**: AI-generated summary text
<!-- AI-SUMMARY-END -->

<!-- AI-SEARCH-TERMS-START -->
**Search Terms**: term1, term2, term3
<!-- AI-SEARCH-TERMS-END -->
```

### Behavior
1. **First run**: Adds content with markers
2. **Subsequent runs**: Replaces content between markers (clean update)
3. **User edits preserved**: Markers remain, content can be edited
4. **User ownership**: Remove markers → AI skips updates (respects user control)

### Benefits
- ✅ Safe to re-run commands multiple times
- ✅ No duplicate content accumulation
- ✅ Users can edit AI-generated content
- ✅ Users can take full ownership by removing markers
- ✅ No database state needed (markers are in document)
- ✅ Works even if document is copied/moved

### Configuration
```yaml
enhancement:
  idempotent_updates: true         # Enable marker-based updates
  respect_user_ownership: true     # Skip if markers removed

commands:
  summarize:
    use_markers: true
    respect_no_markers: true       # Don't override user-owned content
  search_terms:
    use_markers: true
    respect_no_markers: true
```

## Simplified Q&A System

### Changed
- **Before**: Supported both `?!?` and `/ai` markers for questions
- **After**: Only `/ai` command supported

### Rationale
- Consistency: All commands use `/` prefix
- Simplicity: One pattern to detect and document
- Clear intent: `/ai` is explicit command, not punctuation

### Usage
```markdown
/ai What is our deployment process?
/ai How do we handle authentication?
```

## Benefits of Command-Driven Approach with Guidance

1. **User Control**: User decides when document is ready to be filed
2. **Reduced API Calls**: Only process documents user explicitly marks
3. **Simpler Architecture**: No complex state machine for document waiting periods
4. **More Predictable**: No mysterious auto-filing happening in background
5. **Better for Collaboration**: Team members won't have documents filed while still editing
6. **Transparency**: Users see when AI is uncertain instead of wrong guesses
7. **Iterative Refinement**: User can provide hints to resolve ambiguity
8. **No Silent Failures**: Documents don't disappear to wrong collections
9. **Educational**: Users learn what content characteristics make filing clear vs ambiguous

## Implementation Impact

### Easier to Implement
- No need for wait period logic
- Simpler database schema
- No need to track document discovery timestamps
- Fewer edge cases (document deleted during wait period, etc.)

### Same Complexity
- Still need taxonomy builder
- Still need AI analysis
- Still need worker pool for concurrency
- Still need rate limiting

### New Complexity (Interactive Guidance)
- Command parser must extract guidance text
- AI prompt must incorporate user guidance
- Document editing to convert markers (/ → ?)
- Comment generation for uncertainty scenarios
- Dual marker detection and cleanup
- AI response must include alternatives for low confidence

## Configuration Example

```yaml
# Before
outline:
  scratch_pad_collection_id: "abc123"

processing:
  poll_interval: 30s
  document_wait_time: 5m

# After
outline:
  excluded_collection_ids: []

processing:
  command_poll_interval: 30s
  qna_poll_interval: 60s
```

## User Experience

### Before
1. Create document in Scratch Pad
2. Wait 5 minutes (or configured wait time)
3. Document automatically filed

### After
1. Create document anywhere
2. When ready, add `/ai-file` line
3. Document immediately processed and filed

**Note**: The "after" approach gives users more control and is less surprising. Users explicitly opt-in to filing rather than having it happen automatically.
